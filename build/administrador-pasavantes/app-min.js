"use strict";function _classCallCheck(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,a){for(var e=0;e<a.length;e++){var n=a[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(a,e,n){return e&&t(a.prototype,e),n&&t(a,n),a}}(),administradorPasavantes=angular.module("administradorPasavantes",["ui.router","ui.bootstrap","ngAnimate","LocalStorageModule"]);administradorPasavantes.config(["$stateProvider","$urlRouterProvider","localStorageFactoryProvider",function(t,a,e){var n=e.$get();a.otherwise(function(t){var a=t.get("$state");a.go("pasavantes")}),t.state("pasavantes",{url:"/pasavantes",templateUrl:"view/pasavantes.html",controller:"pasavantesCtrl",resolve:{tipoNavegacion:n.getTraffic,muelles:n.getHarbors,tarifas:n.getRates}}).state("error",{url:"/error",templateUrl:"view/error.html"})}]),administradorPasavantes.run(["$rootScope","$state","$window",function(t,a,e){t.$on("$stateChangeError",function(t,e,n,r,s,i){a.go("error")}),t.goBack=function(){e.history.back()}}]),administradorPasavantes.constant("APP_CONFIG",{SERVER_URL:"http://terminales.puertobuenosaires.gob.ar:8099",API_ENDPOINT:"http://www.e-puertobue.com.ar/ws"}),administradorPasavantes.factory("Pasavante",["$http","APP_CONFIG","$q","Tarifa",function(t,a,e,n){var r=function(){function t(a){_classCallCheck(this,t),this.ID_TIPO_NAVEGACION=0,this.TERMINALES=[{ID_TERMINAL:0,TARIFAS:[]}],this.VALOR_MINIMO=0,a&&this.setData(a)}return _createClass(t,[{key:"setData",value:function(t){angular.extend(this,t),this.DETALLE=!1;var a=!0,e=!1,r=void 0;try{for(var s,i=this.TERMINALES[Symbol.iterator]();!(a=(s=i.next()).done);a=!0){var o=s.value,u=0;o.VALOR_TOTAL=0;var I=!0,c=!1,l=void 0;try{for(var A,f=o.TARIFAS[Symbol.iterator]();!(I=(A=f.next()).done);I=!0){var v=A.value;v=new n(v),v.MINIMO?o.VALOR_MINIMO=v.VALOR_TARIFA:o.VALOR_TOTAL+=v.VALOR_TARIFA,o.TARIFAS[u]=v,u++}}catch(t){c=!0,l=t}finally{try{!I&&f.return&&f.return()}finally{if(c)throw l}}}}catch(t){e=!0,r=t}finally{try{!a&&i.return&&i.return()}finally{if(e)throw r}}}},{key:"resetTarifaId",value:function(){var t=!0,a=!1,e=void 0;try{for(var n,r=this.TERMINALES[0].TARIFAS[Symbol.iterator]();!(t=(n=r.next()).done);t=!0){var s=n.value;s.ID=void 0}}catch(t){a=!0,e=t}finally{try{!t&&r.return&&r.return()}finally{if(a)throw e}}}},{key:"addRate",value:function(){this.TERMINALES[0].TARIFAS.push(new n)}},{key:"removeRate",value:function(t){this.TERMINALES[0].TARIFAS[t].ID?(this.TERMINALES[0].TARIFAS[t].FECHA_FIN=new Date,this.TERMINALES[0].TARIFAS[t].FECHA_FIN.setHours(0,0),this.TERMINALES[0].TARIFAS[t].MINIMO=!1):this.TERMINALES[0].TARIFAS.splice(t,1)}},{key:"saveChanges",value:function(){var t=this,a=e.defer();if(this.TERMINALES[0].TARIFAS.length>0){var n=[],r=!0,s=!1,i=void 0;try{for(var o,u=this.TERMINALES[0].TARIFAS[Symbol.iterator]();!(r=(o=u.next()).done);r=!0){var I=o.value;n.push(I.savePasavante(this.ID_TIPO_NAVEGACION,this.TERMINALES[0].ID_TERMINAL))}}catch(t){s=!0,i=t}finally{try{!r&&u.return&&u.return()}finally{if(s)throw i}}e.all(n).then(function(e){var n=0,r={};e.forEach(function(t){t&&n++}),0==n&&(r={status:"ERROR",message:"Se produjo un error al intentar guardar las tarifas."},a.reject(r)),n==t.TERMINALES[0].TARIFAS.length?(r={status:"OK"},a.resolve(r)):(r={status:"ERROR",data:t.TERMINALES[0].TARIFAS.length-n},a.resolve(r))})}else{var c={status:"NORATES",message:"Debe seleccionar una tarifa para guardar."};a.reject(c)}return a.promise}},{key:"tipoNavegacion",set:function(t){this.ID_TIPO_NAVEGACION=t,this.resetTarifaId()}},{key:"muelle",set:function(t){this.TERMINALES[0].ID_TERMINAL=t,this.resetTarifaId()}}]),t}();return r}]),administradorPasavantes.factory("Tarifa",["$http","APP_CONFIG","$q",function(t,a,e){var n=function(){function n(t){_classCallCheck(this,n),this.MINIMO=!1,this.VALOR_MINIMO=1,this.CONTROL_MIN=!0,this.DESDE_OPENED=!1,this.HASTA_OPENED=!1,this.DESDE_OPTIONS={},this.HASTA_OPTIONS={minDate:new Date},this.STATUS="",t&&this.setData(t)}return _createClass(n,[{key:"setData",value:function(t){angular.extend(this,t),this.DESCRIPCION&&(this.DESCRI_TARIFA=this.DESCRIPCION),this.CONTROL_MIN&&(this.MINIMO&&(this.VALOR_MINIMO=this.MINIMO,this.MINIMO=!0),this.CONTROL_MIN=!1),null!=this.FECHA_FIN&&(this.FECHA_FIN=new Date(this.FECHA_FIN)),null!=this.FECHA_INICIO&&(this.FECHA_INICIO=new Date(this.FECHA_INICIO))}},{key:"getValor",value:function(){var n=this,r=e.defer(),s=a.SERVER_URL+"/rates/"+this.ID_TARIFA;return t.get(s).then(function(t){0==t.data.data[0].VALORES.length?n.VALOR=0:n.VALOR=t.data.data[0].VALORES[0].VALOR_TARIFA,r.resolve()},function(t){r.reject(t.data)}),r.promise}},{key:"disable",value:function(){var n=this,r=e.defer(),s=a.SERVER_URL+"/pasavantes/pasavante/disable/"+this.ID;return t.put(s).then(function(t){"OK"==t.data.status?(n.FECHA_FIN=new Date,r.resolve(t.data)):r.reject(t.data)},function(t){r.reject(t.data)}),r.promise}},{key:"enable",value:function(){var n=this,r=e.defer(),s=a.SERVER_URL+"/pasavantes/pasavante/update/"+this.ID,i={};return i.id_tipo_navegacion=parseInt(navegacion),i.id_terminal=parseInt(muelle),this.FECHA_INICIO&&(i.fecha_inicio=this.FECHA_INICIO),this.MINIMO&&(i.minimo=1),t.put(s,i).then(function(t){"OK"==t.data.status?(n.FECHA_FIN=null,r.resolve(t.data)):r.reject(t.data)},function(t){r.reject(t.data)}),r.promise}},{key:"buildAdapterObject",value:function(t,a){var e={};return e.id_tipo_navegacion=parseInt(t),e.id_terminal=parseInt(a),e.id_tarifa=this.ID_TARIFA,this.FECHA_INICIO&&(e.fecha_inicio=this.FECHA_INICIO),this.FECHA_FIN&&(e.fecha_fin=this.FECHA_FIN),this.MINIMO?e.minimo=this.VALOR_MINIMO:e.minimo=0,e}},{key:"savePasavante",value:function(t,a){var n=this,r=e.defer(),s=this.buildAdapterObject(t,a);return this.ID?this.updateRate(s).then(function(t){"OK"==t.data.status?(n.STATUS="OK",r.resolve(!0)):(n.STATUS="ERROR",r.resolve(!1))},function(t){n.STATUS="ERROR",n.ERROR=t.data.message,r.resolve(!1)}):this.addRate(s).then(function(t){"OK"==t.data.status?(n.STATUS="OK",n.ID=t.data.data.ID,r.resolve(!0)):(n.STATUS="ERROR",r.resolve(!1))},function(t){n.STATUS="ERROR",n.ERROR=t.data.message,r.resolve(!1)}),r.promise}},{key:"addRate",value:function(e){var n=a.SERVER_URL+"/pasavantes/pasavante";return t.post(n,e)}},{key:"updateRate",value:function(e){var n=a.SERVER_URL+"/pasavantes/pasavante/update/"+this.ID;return t.put(n,e)}},{key:"unsetData",value:function(){this.BACKUP="",this.ID_TARIFA="",this.CODIGO_TARIFA="",this.DESCRI_TARIFA="",this.SIMBOLO="",this.CODIGO_AFIP="",this.VALOR="",this.ID=void 0}},{key:"VALOR_TARIFA",get:function(){return this.MINIMO?this.VALOR_MINIMO:this.VALOR}},{key:"data",set:function(t){this.ID_TARIFA=t.ID_TARIFA,this.CODIGO_TARIFA=t.CODIGO_TARIFA,this.DESCRI_TARIFA=t.DESCRI_TARIFA,this.SIMBOLO=t.SIMBOLO,this.CODIGO_AFIP=t.CODIGO_AFIP,this.getValor()}},{key:"fullDescription",get:function(){return this.CODIGO_TARIFA+" - "+this.DESCRI_TARIFA}}]),n}();return n}]),administradorPasavantes.controller("pasavantesCtrl",["$scope","Pasavante","Tarifa","pasavantesFactory","localStorageService","dialogsService","$timeout",function(t,a,e,n,r,s,i){function o(){n.getPasavantes().then(function(a){t.pasavantes=a,t.pasavantes.forEach(function(a){t.traficos[a.ID_TIPO_NAVEGACION]?a.NAVEGACION=t.traficos[a.ID_TIPO_NAVEGACION].DESC_TRAFICO:a.NAVEGACION="Error - No se ha encontrado el tipo de navegación",a.TERMINALES.forEach(function(a){t.muelles[a.ID_TERMINAL]?a.MUELLE=t.muelles[a.ID_TERMINAL].DESCRIPCION_MUELLE:a.MUELLE="ERROR - MUELLE NO ENCONTRADO.",a.TARIFAS.forEach(function(a){a.CODIGO_TARIFA=t.tarifas[a.ID_TARIFA].CODIGO_TARIFA})})})},function(t){s.error("Error",t.message)})}function u(){t.pasavantes.forEach(function(a){a.ID_TIPO_NAVEGACION==t.nuevoPasavante.ID_TIPO_NAVEGACION&&a.TERMINALES.forEach(function(a){a.ID_TERMINAL==t.nuevoPasavante.TERMINALES[0].ID_TERMINAL&&a.TARIFAS.forEach(function(a){for(var e=0;e<t.nuevoPasavante.TERMINALES[0].TARIFAS.length;e++)t.nuevoPasavante.TERMINALES[0].TARIFAS[e].ID_TARIFA==a.ID_TARIFA&&(t.nuevoPasavante.TERMINALES[0].TARIFAS[e].ID=a.ID)})})})}t.fecha=new Date,t.nuevoPasavante=new a,t.tarifas=[],t.pasavantes=[],t.muelles=[],t.traficos=[],t.searchText="",t.pasavanteGuardado=!1,r.get("muelles").forEach(function(a){t.muelles[a.CODIGO_MUELLE]=a}),r.get("trafico").forEach(function(a){t.traficos[a.ID_TRAFICO]=a}),r.get("tarifas").forEach(function(a){t.tarifas[a.ID_TARIFA]=new e(a)}),t.setNavegacion=function(a,e,n,r){t.nuevoPasavante.tipoNavegacion=a.ID_TRAFICO},t.unsetNavegacion=function(){t.nuevoPasavante.NAVEGACION="",t.nuevoPasavante.tipoNavegacion=0},t.setMuelle=function(a,e,n,r){t.nuevoPasavante.muelle=a.CODIGO_MUELLE},t.unsetMuelle=function(){t.nuevoPasavante.TERMINALES[0].MUELLE="",t.nuevoPasavante.muelle=0},t.checkMuelle=function(){i(function(){void 0==t.nuevoPasavante.TERMINALES[0].MUELLE&&t.unsetMuelle()},1)},t.preventSubmit=function(t){13==t.keyCode&&t.preventDefault()},t.setMinimo=function(a){for(var e=0;e<t.nuevoPasavante.TERMINALES[0].TARIFAS.length;e++)a!=e&&(t.nuevoPasavante.TERMINALES[0].TARIFAS[e].MINIMO=!1)},t.setTarifa=function(a,e,n,r,s){t.nuevoPasavante.TERMINALES[0].TARIFAS[s].data=a},t.unsetTarifa=function(a){t.nuevoPasavante.TERMINALES[0].TARIFAS[a].unsetData()},t.setMinDate=function(t){t.FECHA_INICIO?t.HASTA_OPTIONS={minDate:t.FECHA_INICIO}:t.HASTA_OPTIONS={minDate:new Date}},t.setMaxDate=function(t){t.FECHA_FIN?t.DESDE_OPTIONS={maxDate:t.FECHA_FIN}:t.DESDE_OPTIONS={}},t.disableRate=function(a){var e=s.confirm("Dar de baja tarifa","Se dará de baja la tarifa seleccionada. ¿Confirma la operación?");e.result.then(function(){a.disable().then(function(a){t.fecha=new Date},function(t){s.error("Error",t.message)})})},t.enableRate=function(t,a,e){e.enable(t,a).then(function(t){},function(t){s.error("Error",t.message)})},t.guardarPasavante=function(){t.pasavanteGuardado=!0,u(),t.nuevoPasavante.saveChanges().then(function(t){"OK"==t.status?s.notify("Pasavantes","Todas las tarifas se guardaron correctamente"):s.notify("Pasavantes","Se produjeron errores en "+t.data+"tarifas."),o()},function(t){"NORATES"==t.status?s.notify("Pasavantes",t.message):s.error("Pasavantes",t.message)})},t.editarPasavante=function(e,n,r){r.stopPropagation();var s={ID_TIPO_NAVEGACION:e.ID_TIPO_NAVEGACION,NAVEGACION:t.traficos[e.ID_TIPO_NAVEGACION],TERMINALES:[angular.copy(e.TERMINALES[n])]};s.TERMINALES[0].MUELLE=t.muelles[s.TERMINALES[0].ID_TERMINAL];for(var i=0;i<s.TERMINALES[0].TARIFAS.length;i++)s.TERMINALES[0].TARIFAS[i].BACKUP=t.tarifas[s.TERMINALES[0].TARIFAS[i].ID_TARIFA];t.nuevoPasavante=new a(s)},t.limpiarFormulario=function(){t.nuevoPasavante=new a},o()}]),administradorPasavantes.factory("localStorageFactory",["$http","$q","APP_CONFIG","localStorageService",function(t,a,e,n){var r={getRates:function(){var r=a.defer(),s=e.SERVER_URL+"/rates/document/11";return t.get(s).then(function(t){n.set("tarifas",t.data.data),r.resolve()},function(t){r.reject()}),r.promise},getTraffic:function(){var r=a.defer(),s=e.API_ENDPOINT+"/ws-trafico.php";return t.get(s).then(function(t){n.set("trafico",t.data),r.resolve()},function(t){r.reject()}),r.promise},getHarbors:function(){var r=a.defer(),s=e.API_ENDPOINT+"/ws-sitios.php";return t.get(s).then(function(t){n.set("muelles",t.data),r.resolve()},function(t){r.reject()}),r.promise}};return r}]),administradorPasavantes.factory("pasavantesFactory",["$http","$q","APP_CONFIG","Pasavante","Tarifa","localStorageService",function(t,a,e,n,r,s){var i={muelles:s.get("muelles"),trafico:s.get("trafico"),tarifas:s.get("tarifas"),getPasavantes:function(){var r=a.defer(),s=e.SERVER_URL+"/pasavantes";return t.get(s).then(function(t){"OK"==t.data.status?!function(){var a=[];t.data.data.forEach(function(t){var e=new n(t);a.push(e)}),r.resolve(a)}():r.reject(t.data)},function(t){r.reject(t.data)}),r.promise}};return i}]),administradorPasavantes.service("dialogsService",["$uibModal",function(t){return{confirm:function(a,e){return t.open({controller:"dialogsCtrl",templateUrl:"./service/dialogs/confirm.html",resolve:{title:function(){return a},message:function(){return e}}})},error:function(a,e){return t.open({controller:"dialogsCtrl",templateUrl:"./service/dialogs/error.html",resolve:{title:function(){return a},message:function(){return e}}})},notify:function(a,e){return t.open({controller:"dialogsCtrl",templateUrl:"./service/dialogs/notify.html",resolve:{title:function(){return a},message:function(){return e}}})},login:function(){return t.open({controller:"loginDialogCtrl",templateUrl:"./service/dialogs/login.html",backdrop:"static"})}}}]),administradorPasavantes.controller("dialogsCtrl",["$scope","$uibModalInstance","title","message",function(t,a,e,n){t.modalData={title:e,message:n},console.log(t.modalData),t.ok=function(){a.close()},t.cancel=function(){a.dismiss("cancel")}}]),administradorPasavantes.controller("loginDialogCtrl",["$scope","$uibModalInstance","loginFactory",function(t,a,e){t.user={name:"",password:"",session:!1,role:"admin"},t.login=function(){e.login(t.user,function(t){a.close(t)})},t.cancel=function(){a.dismiss("cancel")}}]);