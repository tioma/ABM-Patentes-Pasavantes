var administradorPasavantes=angular.module("administradorPasavantes",["ui.router","ui.bootstrap","ngAnimate","LocalStorageModule"]);administradorPasavantes.config(["$stateProvider","$urlRouterProvider","localStorageFactoryProvider",function(a,t,e){var n=e.$get();t.otherwise(function(a){var t=a.get("$state");t.go("pasavantes")}),a.state("pasavantes",{url:"/pasavantes",templateUrl:"view/pasavantes.html",controller:"pasavantesCtrl",resolve:{tipoNavegacion:n.getTraffic,muelles:n.getHarbors,tarifas:n.getRates}}).state("error",{url:"/error",templateUrl:"view/error.html"})}]),administradorPasavantes.run(["$rootScope","$state","$window",function(a,t,e){a.$on("$stateChangeError",function(a,e,n,r,s,o){t.go("error")}),a.goBack=function(){e.history.back()}}]),administradorPasavantes.constant("APP_CONFIG",{SERVER_URL:"http://terminales.puertobuenosaires.gob.ar:8099",API_ENDPOINT:"http://www.e-puertobue.com.ar/ws"}),administradorPasavantes.factory("Pasavante",["$http","APP_CONFIG","$q","Tarifa",function(a,t,e,n){function r(a){a?this.setData(a):this.TERMINALES=[{ID_TERMINAL:0,TARIFAS:[]}]}return r.prototype={setData:function(a){angular.extend(this,a),this.VALOR_TOTAL=0,this.DETALLE=!1;for(var t=0;t<this.TERMINALES.length;t++)for(var e=0;e<this.TERMINALES[t].TARIFAS.length;e++)this.TERMINALES[t].TARIFAS[e]=new n(this.TERMINALES[t].TARIFAS[e]),this.VALOR_TOTAL+=this.TERMINALES[t].TARIFAS[e].VALOR},resetTarifasId:function(){for(var a=0;a<this.TERMINALES[0].TARIFAS.length;a++)this.TERMINALES[0].TARIFAS[a].ID=void 0},setTipoNavegacion:function(a){this.ID_TIPO_NAVEGACION=a,this.resetTarifasId()},setMuelle:function(a){this.TERMINALES[0].ID_TERMINAL=a,this.resetTarifasId()},addRate:function(){this.TERMINALES[0].TARIFAS.push(new n)},removeRate:function(a){this.TERMINALES[0].TARIFAS.splice(a,1)},saveChanges:function(){var a=e.defer(),t=this;if(this.TERMINALES[0].TARIFAS.length>0){for(var n=[],r=0;r<this.TERMINALES[0].TARIFAS.length;r++)n.push(this.TERMINALES[0].TARIFAS[r].savePasavante(this.ID_TIPO_NAVEGACION,this.TERMINALES[0].ID_TERMINAL));e.all(n).then(function(e){var n=0,r={};e.forEach(function(a){a&&n++}),0==n&&(r={status:"ERROR",message:"Se produjo un error al intentar guardar las tarifas."},a.reject(r)),n==t.TERMINALES[0].TARIFAS.length?(r={status:"OK"},a.resolve(r)):(r={status:"ERROR",data:t.TERMINALES[0].TARIFAS.length-n},a.resolve(r))})}else{var s={status:"NORATES",message:"Debe seleccionar una tarifa para guardar."};a.reject(s)}return a.promise}},r}]),administradorPasavantes.factory("Tarifa",["$http","APP_CONFIG","$q",function(a,t,e){function n(a){this.MINIMO=!1,this.DESDE_OPENED=!1,this.HASTA_OPENED=!1,this.DESDE_OPTIONS={},this.HASTA_OPTIONS={minDate:new Date},this.STATUS="",a&&this.setData(a)}return n.prototype={setData:function(a){angular.extend(this,a),this.MINIMO=1==this.MINIMO,null!=this.FECHA_FIN&&(this.FECHA_FIN=new Date(this.FECHA_FIN)),null!=this.FECHA_INICIO&&(this.FECHA_INICIO=new Date(this.FECHA_INICIO))},getValor:function(){var n=e.defer(),r=t.SERVER_URL+"/rates/"+this.ID_TARIFA,s=this;return a.get(r).then(function(a){0==a.data.data[0].VALORES.length?s.VALOR=0:s.VALOR=a.data.data[0].VALORES[0].VALOR_TARIFA,n.resolve()},function(a){n.reject(a.data)}),n.promise},formatData:function(){return this.CODIGO_TARIFA+" - "+this.DESCRI_TARIFA},disable:function(){var n=e.defer(),r=t.SERVER_URL+"/pasavantes/pasavante/disable/"+this.ID,s=this;return a.put(r).then(function(a){"OK"==a.data.status?(s.FECHA_FIN=new Date,n.resolve(a.data)):n.reject(a.data)},function(a){n.reject(a.data)}),n.promise},buildAdapterObject:function(a,t){var e={};return e.id_tipo_navegacion=parseInt(a),e.id_terminal=parseInt(t),e.id_tarifa=this.ID_TARIFA,this.FECHA_INICIO&&(e.fecha_inicio=this.FECHA_INICIO),this.FECHA_FIN&&(e.fecha_fin=this.FECHA_FIN),this.MINIMO&&(e.minimo=1),e},enable:function(n,r){var s=e.defer(),o=t.SERVER_URL+"/pasavantes/pasavante/update/"+this.ID,i={};i.id_tipo_navegacion=parseInt(n),i.id_terminal=parseInt(r),this.FECHA_INICIO&&(i.fecha_inicio=this.FECHA_INICIO),this.MINIMO&&(i.minimo=1);var I=this;return a.put(o,i).then(function(a){"OK"==a.data.status?(I.FECHA_FIN=null,s.resolve(a.data)):s.reject(a.data)},function(a){s.reject(a.data)}),s.promise},savePasavante:function(a,t){var n=e.defer(),r=this,s=this.buildAdapterObject(a,t);return this.ID?this.updateRate(s).then(function(a){"OK"==a.data.status?(r.STATUS="OK",n.resolve(!0)):(r.STATUS="ERROR",n.resolve(!1))},function(a){r.STATUS="ERROR",r.ERROR=a.data.message,n.resolve(!1)}):this.addRate(s).then(function(a){"OK"==a.data.status?(r.STATUS="OK",r.ID=a.data.data.ID,n.resolve(!0)):(r.STATUS="ERROR",n.resolve(!1))},function(a){r.STATUS="ERROR",r.ERROR=a.data.message,n.resolve(!1)}),n.promise},addRate:function(e){var n=t.SERVER_URL+"/pasavantes/pasavante";return a.post(n,e)},updateRate:function(e){var n=t.SERVER_URL+"/pasavantes/pasavante/update/"+this.ID;return a.put(n,e)}},n}]),administradorPasavantes.controller("pasavantesCtrl",["$scope","Pasavante","Tarifa","pasavantesFactory","localStorageService","dialogsService",function(a,t,e,n,r,s){function o(){n.getPasavantes().then(function(t){a.pasavantes=t,a.pasavantes.forEach(function(t){a.traficos[t.ID_TIPO_NAVEGACION]?t.NAVEGACION=a.traficos[t.ID_TIPO_NAVEGACION].DESC_TRAFICO:t.NAVEGACION="Error - No se ha encontrado el tipo de navegación",t.TERMINALES.forEach(function(t){a.muelles[t.ID_TERMINAL]?t.MUELLE=a.muelles[t.ID_TERMINAL].DESCRIPCION_MUELLE:t.MUELLE="ERROR - MUELLE NO ENCONTRADO.",t.TARIFAS.forEach(function(t){t.CODIGO_TARIFA=a.tarifas[t.ID_TARIFA].CODIGO_TARIFA})})})},function(a){s.error("Error",a.message)})}function i(){a.pasavantes.forEach(function(t){t.ID_TIPO_NAVEGACION==a.nuevoPasavante.ID_TIPO_NAVEGACION&&t.TERMINALES.forEach(function(t){t.ID_TERMINAL==a.nuevoPasavante.TERMINALES[0].ID_TERMINAL&&t.TARIFAS.forEach(function(t){for(var e=0;e<a.nuevoPasavante.TERMINALES[0].TARIFAS.length;e++)a.nuevoPasavante.TERMINALES[0].TARIFAS[e].ID_TARIFA==t.ID_TARIFA&&(a.nuevoPasavante.TERMINALES[0].TARIFAS[e].ID=t.ID)})})})}a.fecha=new Date,a.nuevoPasavante=new t,a.tarifas=[],a.pasavantes=[],a.muelles=[],a.traficos=[],a.searchText="",a.pasavanteGuardado=!1,r.get("muelles").forEach(function(t){a.muelles[t.CODIGO_MUELLE]=t}),r.get("trafico").forEach(function(t){a.traficos[t.ID_TRAFICO]=t}),r.get("tarifas").forEach(function(t){a.tarifas[t.ID_TARIFA]=new e(t)}),a.setNavegacion=function(t,e,n,r){a.nuevoPasavante.setTipoNavegacion(t.ID_TRAFICO)},a.setMuelle=function(t,e,n,r){a.nuevoPasavante.setMuelle(t.CODIGO_MUELLE)},a.setMinimo=function(t){for(var e=0;e<a.nuevoPasavante.TERMINALES[0].TARIFAS.length;e++)t!=e&&(a.nuevoPasavante.TERMINALES[0].TARIFAS[e].MINIMO=!1)},a.setTarifa=function(t,e,n,r,s){a.nuevoPasavante.TERMINALES[0].TARIFAS[s].ID_TARIFA=t.ID_TARIFA,a.nuevoPasavante.TERMINALES[0].TARIFAS[s].CODIGO_TARIFA=t.CODIGO_TARIFA,a.nuevoPasavante.TERMINALES[0].TARIFAS[s].DESCRI_TARIFA=t.DESCRI_TARIFA,a.nuevoPasavante.TERMINALES[0].TARIFAS[s].SIMBOLO=t.SIMBOLO,a.nuevoPasavante.TERMINALES[0].TARIFAS[s].CODIGO_AFIP=t.CODIGO_AFIP,a.nuevoPasavante.TERMINALES[0].TARIFAS[s].getValor()},a.unsetTarifa=function(t){a.nuevoPasavante.TERMINALES[0].TARIFAS[t].BACKUP="",a.nuevoPasavante.TERMINALES[0].TARIFAS[t].ID_TARIFA="",a.nuevoPasavante.TERMINALES[0].TARIFAS[t].CODIGO_TARIFA="",a.nuevoPasavante.TERMINALES[0].TARIFAS[t].DESCRI_TARIFA="",a.nuevoPasavante.TERMINALES[0].TARIFAS[t].SIMBOLO="",a.nuevoPasavante.TERMINALES[0].TARIFAS[t].CODIGO_AFIP="",a.nuevoPasavante.TERMINALES[0].TARIFAS[t].VALOR=""},a.setMinDate=function(a){a.FECHA_INICIO?a.HASTA_OPTIONS={minDate:a.FECHA_INICIO}:a.HASTA_OPTIONS={minDate:new Date}},a.setMaxDate=function(a){a.FECHA_FIN?a.DESDE_OPTIONS={maxDate:a.FECHA_FIN}:a.DESDE_OPTIONS={}},a.disableRate=function(t){var e=s.confirm("Dar de baja tarifa","Se dará de baja la tarifa seleccionada. ¿Confirma la operación?");e.result.then(function(){t.disable().then(function(t){a.fecha=new Date},function(a){s.error("Error",a.message)})})},a.enableRate=function(a,t,e){e.enable(a,t).then(function(a){},function(a){s.error("Error",a.message)})},a.guardarPasavante=function(){a.pasavanteGuardado=!0,i(),a.nuevoPasavante.saveChanges().then(function(a){"OK"==a.status?s.notify("Pasavantes","Todas las tarifas se guardaron correctamente"):s.notify("Pasavantes","Se produjeron errores en "+a.data+"tarifas."),o()},function(a){"NORATES"==a.status?s.notify("Pasavantes",a.message):s.error("Pasavantes",a.message)})},a.editarPasavante=function(e,n,r){r.stopPropagation();var s={ID_TIPO_NAVEGACION:e.ID_TIPO_NAVEGACION,NAVEGACION:a.traficos[e.ID_TIPO_NAVEGACION],TERMINALES:[angular.copy(e.TERMINALES[n])]};s.TERMINALES[0].MUELLE=a.muelles[s.TERMINALES[0].ID_TERMINAL];for(var o=0;o<s.TERMINALES[0].TARIFAS.length;o++)s.TERMINALES[0].TARIFAS[o].BACKUP=a.tarifas[s.TERMINALES[0].TARIFAS[o].ID_TARIFA];a.nuevoPasavante=new t(s)},a.limpiarFormulario=function(){a.nuevoPasavante=new t},o()}]),administradorPasavantes.factory("localStorageFactory",["$http","$q","APP_CONFIG","localStorageService",function(a,t,e,n){var r={getRates:function(){var r=t.defer(),s=e.SERVER_URL+"/rates/document/11";return a.get(s).then(function(a){n.set("tarifas",a.data.data),r.resolve()},function(a){r.reject()}),r.promise},getTraffic:function(){var r=t.defer(),s=e.API_ENDPOINT+"/ws-trafico.php";return a.get(s).then(function(a){n.set("trafico",a.data),r.resolve()},function(a){r.reject()}),r.promise},getHarbors:function(){var r=t.defer(),s=e.API_ENDPOINT+"/ws-sitios.php";return a.get(s).then(function(a){n.set("muelles",a.data),r.resolve()},function(a){r.reject()}),r.promise}};return r}]),administradorPasavantes.factory("pasavantesFactory",["$http","$q","APP_CONFIG","Pasavante","Tarifa","localStorageService",function(a,t,e,n,r,s){var o={muelles:s.get("muelles"),trafico:s.get("trafico"),tarifas:s.get("tarifas"),getPasavantes:function(){var r=t.defer(),s=e.SERVER_URL+"/pasavantes";return a.get(s).then(function(a){if("OK"==a.data.status){var t=[];a.data.data.forEach(function(a){var e=new n(a);t.push(e)}),r.resolve(t)}else r.reject(a.data)},function(a){r.reject(a.data)}),r.promise}};return o}]),administradorPasavantes.service("dialogsService",["$uibModal",function(a){return{confirm:function(t,e){return a.open({controller:"dialogsCtrl",templateUrl:"./service/dialogs/confirm.html",resolve:{title:function(){return t},message:function(){return e}}})},error:function(t,e){return a.open({controller:"dialogsCtrl",templateUrl:"./service/dialogs/error.html",resolve:{title:function(){return t},message:function(){return e}}})},notify:function(t,e){return a.open({controller:"dialogsCtrl",templateUrl:"./service/dialogs/notify.html",resolve:{title:function(){return t},message:function(){return e}}})},login:function(){return a.open({controller:"loginDialogCtrl",templateUrl:"./service/dialogs/login.html",backdrop:"static"})}}}]),administradorPasavantes.controller("dialogsCtrl",["$scope","$uibModalInstance","title","message",function(a,t,e,n){a.modalData={title:e,message:n},console.log(a.modalData),a.ok=function(){t.close()},a.cancel=function(){t.dismiss("cancel")}}]),administradorPasavantes.controller("loginDialogCtrl",["$scope","$uibModalInstance","loginFactory",function(a,t,e){a.user={name:"",password:"",session:!1,role:"admin"},a.login=function(){e.login(a.user,function(a){t.close(a)})},a.cancel=function(){t.dismiss("cancel")}}]);